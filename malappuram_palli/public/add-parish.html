<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Toney Abraham">
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet">

    <title>Malappuram Palli | Admin Page</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/owl.css">
    <link rel="stylesheet" href="assets/css/lightbox.css">
    <link rel="stylesheet" href="assets/css/custom.css">

    <style>
        .formcontainer {
            max-width: 500px;
            margin: auto;
            background: #BB9457;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 20px;
            color: #6F1D1B;
        }

        label {
            display: block;
            margin: 8px 0 4px;
            font-weight: bold;
            font-size: 14px;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #432818;
            border-radius: 6px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
        }

        button {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            background: #6F1D1B;
            border: none;
            border-radius: 6px;
            color: 432818;
            font-size: 15px;
            cursor: pointer;
        }

        button:hover {
            background: #432818;
        }

        #status {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .subbutton {
            background-color: #99582A;
            color: whitesmoke;
            font-family: Georgia, 'Times New Roman', Times, serif;
            border: none;
            font-size: 18px;
            padding: 10px;
            width: 100px;
            border-radius: 10px;

        }

        .subbutton:hover {
            box-shadow: 3px 3px 10px black;
        }

        a {
            color: white;
        }

        a:hover {
            color: #FFE6A7;
        }

        option {
            font-size: 15px;
        }
    </style>
</head>

<body id="bodyContent" style="background-color: #432818;">
    <div style="padding: 20px;">
        <a href="admin.html">Go back</a>
    </div>
    <div class="container" style="padding: 20px;">
        <div class="row">
            <div class="col-md-12" style="text-align: center;padding: 20px;margin-top: 20px;">
                <h2 style="color: #BB9457;">ST. Theresa's Church, Malappuram</h1>
            </div>
        </div>
    </div>
    <div class="container formcontainer" style="padding: 20px;">
        <h2>Add Parish Members</h2>
        <form id="parishForm">
            <label for="name">Full Name</label>
            <input type="text" id="name" required>

            <label for="position">Position</label>
            <select id="position" required>
                <option value="">-- Select Position --</option>

            </select>

            <label for="imageUrl">Image URL of Person</label>
            <input type="url" id="imageUrl" placeholder="https://drive.google.com/..." required>

            <button type="submit">Add New Member</button>
        </form>
        <p id="status"></p>
    </div>

    <h3 style="color:#BB9457;margin-top:30px;text-align: center;">Current Parish Members</h3>
    <div id="membersList" class="container" style="padding: 20px;"></div>

    <!-- Footer -->
    <footer
        style="background-color: black;color: white; padding: 20px 0; text-align: center; font-family: Arial, sans-serif;height: 150px; margin-top: 20px;">
        <div class="container">
            <p>Developed by <a href="https://toneyabraham37.github.io/" target="_blank" style="color: inherit;">
                    Toney Abraham</a> | © ST. THERESA'S CHURCH, MALAPPURAM</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <!-- Position script -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const positions = [
                { name: "Vicar", max: 1 },
                { name: "Kaikkaran", max: 2 },
                { name: "Prathinidhiyogam-Secretary", max: 1 },
                { name: "Accountant", max: Infinity },
                { name: "Auditor", max: 1 },
                { name: "Sunday-School-HM", max: 1 },
                { name: "Sunday-School-Secretary", max: 1 },
                { name: "Sacristian", max: Infinity }
            ];

            const positionSelect = document.getElementById("position");

            positions.forEach(pos => {
                const option = document.createElement("option");
                option.value = pos.name;
                option.textContent = pos.name;
                positionSelect.appendChild(option);
            });
        });
    </script>
    <!-- Firebase JS -->
    <script type="module">
        import { auth, db } from './assets/js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, doc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Check login
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                document.getElementById("bodyContent").style.display = "block";
            }
        });

        const form = document.getElementById("parishForm");
        const statusMsg = document.getElementById("status");
        const membersList = document.getElementById("membersList");
        let editDocId = null; // tracks if editing

        // Convert Google Drive link
        function convertDriveLink(url) {
            let match = url.match(/\/d\/([^/]+)\//);
            if (!match) match = url.match(/[?&]id=([^&]+)/);
            return match && match[1] ? `https://lh3.googleusercontent.com/d/${match[1]}` : url;
        }

        // Render members
        onSnapshot(collection(db, "parish-members"), (snapshot) => {
            membersList.innerHTML = "";
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const memberId = docSnap.id;

                const card = document.createElement("div");
                card.style = "border:1px solid #432818;padding:10px;margin-bottom:10px;border-radius:6px;background:#FFE6A7;color:#432818;";
                card.innerHTML = `
            <p><strong>Name:</strong> ${data.name}</p>
            <p><strong>Position:</strong> ${data.position}</p>
            <img src="${data.imageUrl}" alt="${data.name}" style="width:200px;border-radius:6px;"><br>
            <button onclick="editMember('${memberId}', '${data.name}', '${data.position}', '${data.imageUrl}')">Edit</button>
            <button onclick="deleteMember('${memberId}')">Delete</button>
        `;
                membersList.appendChild(card);
            });
        });

        // Submit handler
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            statusMsg.textContent = "⏳ Updating...";

            const name = document.getElementById("name").value.trim();
            const position = document.getElementById("position").value.trim();
            let imageUrl = document.getElementById("imageUrl").value.trim();

            if (position === "null") {
                statusMsg.textContent = "⚠️ Please select a valid position.";
                return;
            }

            if (imageUrl.includes("drive.google.com")) imageUrl = convertDriveLink(imageUrl);

            try {
                const colRef = collection(db, "parish-members");
                const snapshot = await getDocs(colRef);

                const maxPositions = {
                    "Vicar": 1,
                    "Kaikkaran": 2,
                    "Sacristian": Infinity // or a very high number
                };

                const currentMembers = [];
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.position === position) {
                        currentMembers.push({ id: docSnap.id, data });
                    }
                });

                // Check limit
                if (currentMembers.length >= maxPositions[position]) {
                    if (!confirm(`${position} already has ${currentMembers.length} member(s). Do you want to replace the first one?`)) {
                        return;
                    }
                    // Replace the first one
                    await updateDoc(doc(db, "parish-members", currentMembers[0].id), {
                        name,
                        position,
                        imageUrl,
                        createdAt: serverTimestamp()
                    });
                } else {
                    // Add new member
                    await addDoc(collection(db, "parish-members"), {
                        name,
                        position,
                        imageUrl,
                        createdAt: serverTimestamp()
                    });
                }


                statusMsg.textContent = "✅ Updated successfully!";
                form.reset();
            } catch (error) {
                console.error(error);
                statusMsg.textContent = "❌ " + error.message;
            }
        });

        // Edit member
        window.editMember = (id, name, position, imageUrl) => {
            document.getElementById("name").value = name;
            document.getElementById("position").value = position;
            document.getElementById("imageUrl").value = imageUrl;

            editDocId = id; // flag editing
        };

        // Delete member
        window.deleteMember = async (id) => {
            if (confirm("Are you sure you want to delete this member?")) {
                await deleteDoc(doc(db, "parish-members", id));
            }
        };
    </script>


</body>

</html>